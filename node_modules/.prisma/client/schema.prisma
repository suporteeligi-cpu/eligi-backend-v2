generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////
// USER
//////////////////////////

model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  phone    String?
  password String
  role     UserRole
  active   Boolean  @default(true)

  // Relacionamentos
  businessOwned Business?
  provider      Provider?
  appointments  Appointment[]  @relation("AppointmentClient")
  reviews       Review[]
  favorites     Favorite[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  client
  provider
  business_owner
  admin
}

//////////////////////////
// BUSINESS
//////////////////////////

model Business {
  id          String  @id @default(uuid())
  ownerId     String  @unique
  name        String
  description String?
  phone       String?
  active      Boolean @default(true)

  owner User @relation(fields: [ownerId], references: [id])

  providers     Provider[]
  services      Service[]
  appointments  Appointment[]
  payments      Payment[]
  invoices      Invoice[]
  subscriptions Subscription[]
  favorites     Favorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////
// PROVIDER
//////////////////////////

model Provider {
  id         String  @id @default(uuid())
  userId     String  @unique
  businessId String
  bio        String?
  avatarUrl  String?
  rating     Float   @default(0)

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])

  services     ProviderService[]
  appointments Appointment[]     @relation("AppointmentProvider")
  reviews      Review[]
  payments     Payment[]
  invoices     Invoice[]
  favorites    Favorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////
// SERVICES
//////////////////////////

model Service {
  id         String @id @default(uuid())
  businessId String
  name       String
  duration   Int
  price      Float

  business     Business          @relation(fields: [businessId], references: [id])
  providers    ProviderService[]
  appointments Appointment[]     @relation("AppointmentService")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProviderService {
  providerId String
  serviceId  String

  provider Provider @relation(fields: [providerId], references: [id])
  service  Service  @relation(fields: [serviceId], references: [id])

  @@id([providerId, serviceId])
}

//////////////////////////
// APPOINTMENTS
//////////////////////////

model Appointment {
  id         String            @id @default(uuid())
  businessId String
  providerId String
  clientId   String
  serviceId  String
  date       DateTime
  time       String
  status     AppointmentStatus @default(scheduled)

  provider Provider @relation("AppointmentProvider", fields: [providerId], references: [id])
  client   User     @relation("AppointmentClient", fields: [clientId], references: [id])
  service  Service  @relation("AppointmentService", fields: [serviceId], references: [id])
  business Business @relation(fields: [businessId], references: [id])

  payment Payment?
  review  Review?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AppointmentStatus {
  scheduled
  completed
  canceled
}

//////////////////////////
// PAYMENTS
//////////////////////////

model Payment {
  id            String        @id @default(uuid())
  businessId    String
  providerId    String?
  appointmentId String?       @unique
  amount        Float
  method        String
  status        PaymentStatus @default(pending)
  externalId    String?

  provider    Provider?    @relation(fields: [providerId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  business    Business     @relation(fields: [businessId], references: [id])

  invoice Invoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PaymentStatus {
  pending
  approved
  failed
}

//////////////////////////
// INVOICES
//////////////////////////

model Invoice {
  id         String  @id @default(uuid())
  businessId String
  providerId String?
  paymentId  String? @unique
  nfseNumber String?
  nfseStatus String?

  provider Provider? @relation(fields: [providerId], references: [id])
  business Business  @relation(fields: [businessId], references: [id])
  payment  Payment?  @relation(fields: [paymentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////
// BILLING
//////////////////////////

model Plan {
  id       String       @id @default(uuid())
  name     String
  price    Float
  interval PlanInterval

  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PlanInterval {
  monthly
  yearly
}

model Subscription {
  id         String  @id @default(uuid())
  businessId String
  planId     String
  status     String  @default("active")
  externalId String?

  business Business @relation(fields: [businessId], references: [id])
  plan     Plan     @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////
// MARKETPLACE
//////////////////////////

model Review {
  id            String  @id @default(uuid())
  appointmentId String? @unique
  clientId      String
  providerId    String
  rating        Int
  comment       String?

  provider    Provider     @relation(fields: [providerId], references: [id])
  client      User         @relation(fields: [clientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  createdAt DateTime @default(now())
}

model Favorite {
  id         String  @id @default(uuid())
  clientId   String
  providerId String?
  businessId String?

  client   User      @relation(fields: [clientId], references: [id])
  provider Provider? @relation(fields: [providerId], references: [id])
  business Business? @relation(fields: [businessId], references: [id])
}

//////////////////////////
// NOTIFICATIONS
//////////////////////////

model Notification {
  id      String  @id @default(uuid())
  userId  String
  title   String
  message String
  channel String?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////
// WEBHOOKS
//////////////////////////

model WebhookEvent {
  id        String   @id @default(uuid())
  provider  String
  event     String
  payload   Json
  createdAt DateTime @default(now())
}
